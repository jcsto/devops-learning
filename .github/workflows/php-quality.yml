# ============================================================================
# GITHUB ACTIONS WORKFLOW: PHP Code Quality para Symfony 6.4.9
# ============================================================================
# Flujo de branches de la empresa:
# feature/xyz (custom branch) ‚Üí PR ‚Üí release/development
#                            ‚Üí PR ‚Üí release/uat  
#                            ‚Üí PR ‚Üí release/prod

name: 'PHP Code Quality'

# ============================================================================
# EVENTOS QUE DISPARAN ESTE WORKFLOW
# ============================================================================
# Ejecuta CUANDO:
# 1. Haces git push a cualquier rama (feature/*, release/*)
# 2. Abres un PR hacia release/development, release/uat o release/prod

on:
  # Evento 1: git push (a cualquier rama)
  push:
    paths:
      - 'src/**/*.php'
      - 'config/**/*.php'
      - 'tests/**/*.php'
      - 'composer.json'
      - '.github/workflows/php-quality.yml'
  
  # Evento 2: Pull Request hacia ramas de release
  pull_request:
    branches:
      - release/development  # PRs hacia release/development
      - release/uat          # PRs hacia release/uat
      - release/prod         # PRs hacia release/prod
    paths:
      - 'src/**/*.php'
      - 'config/**/*.php'
      - 'tests/**/*.php'
      - 'composer.json'

# ============================================================================
# JOBS
# ============================================================================
jobs:
  # ========================================================================
  # JOB: PHP Syntax Check
  # ========================================================================
  php-lint:
    name: 'PHP Syntax Check (Symfony 6.4.9)'
    runs-on: ubuntu-latest
    
    steps:
      # STEP 1: Descargar c√≥digo
      - name: Checkout code
        uses: actions/checkout@v4
      
      # STEP 2: Instalar PHP 8.2 (requerido para Symfony 6.4.9)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'  # Symfony 6.4.9 requiere PHP 8.2+
          tools: composer      # Instalar composer
      
      # STEP 3: Chequear sintaxis PHP (no hay errores de sintaxis)
      - name: PHP Lint (Syntax Check)
        run: |
          echo "üîç Chequeando sintaxis PHP..."
          # Busca todos los .php y ejecuta php -l (lint)
          find src config tests -name "*.php" -type f -exec php -l {} \;
          echo "‚úÖ Sintaxis correcta"
      
      # STEP 4: Detectar debug statements (die, var_dump, dd, exit)
      - name: Check for Debug Statements
        run: |
          echo "üîç Buscando debug statements..."
          FOUND=0
          
          # Buscar die()
          if grep -r "die(" src config tests --include="*.php" 2>/dev/null; then
            echo "‚ùå Encontrado: die()"
            FOUND=1
          fi
          
          # Buscar var_dump()
          if grep -r "var_dump(" src config tests --include="*.php" 2>/dev/null; then
            echo "‚ùå Encontrado: var_dump()"
            FOUND=1
          fi
          
          # Buscar dd() (Symfony helper)
          if grep -r "dd(" src config tests --include="*.php" 2>/dev/null; then
            echo "‚ùå Encontrado: dd()"
            FOUND=1
          fi
          
          # Buscar exit()
          if grep -r "exit(" src config tests --include="*.php" 2>/dev/null; then
            echo "‚ùå Encontrado: exit()"
            FOUND=1
          fi
          
          if [ $FOUND -eq 0 ]; then
            echo "‚úÖ No hay debug statements"
          else
            echo "‚ùå Debes remover los debug statements"
            exit 1
          fi
      
      # STEP 5: Detectar hardcoded credentials
      - name: Check for Hardcoded Credentials
        run: |
          echo "üîç Buscando credenciales hardcodeadas..."
          FOUND=0
          
          # Buscar password='...' o password="..."
          if grep -r "password\s*=\s*['\"]" src config --include="*.php" 2>/dev/null | grep -v "password_hash" | grep -v "password_verify"; then
            echo "‚ö†Ô∏è Posible password hardcodeada"
            FOUND=1
          fi
          
          # Buscar api_key='...'
          if grep -r "api_key\s*=\s*['\"]" src config --include="*.php" 2>/dev/null; then
            echo "‚ö†Ô∏è Posible API key hardcodeada"
            FOUND=1
          fi
          
          # Buscar database_url hardcodeada
          if grep -r "DATABASE_URL\s*=\s*['\"]" src config --include="*.php" 2>/dev/null; then
            echo "‚ö†Ô∏è DATABASE_URL hardcodeada"
            FOUND=1
          fi
          
          if [ $FOUND -eq 0 ]; then
            echo "‚úÖ No hay credenciales hardcodeadas"
          else
            echo "‚ùå Usa .env para credenciales, no hardcodees"
            exit 1
          fi
      
      # STEP 6: Validar .env.example existe
      - name: Check .env.example
        run: |
          echo "üîç Validando .env.example..."
          if [ -f ".env.example" ]; then
            echo "‚úÖ .env.example existe (buena pr√°ctica)"
          else
            echo "‚ö†Ô∏è No existe .env.example"
            echo "   Crea uno para que otros desarrolladores sepan qu√© variables necesitan"
          fi
        continue-on-error: true

  # ========================================================================
  # JOB: Composer Validation
  # ========================================================================
  composer-validate:
    name: 'Composer Validation (Symfony Dependencies)'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer
      
      # STEP: Validar composer.json y composer.lock
      - name: Validate composer.json
        run: |
          echo "üîç Validando composer.json..."
          
          # Valida que composer.json sea un JSON v√°lido
          composer validate --strict
          
          # Verifica que composer.lock existe
          if [ ! -f "composer.lock" ]; then
            echo "‚ö†Ô∏è composer.lock no existe"
            echo "   Ejecuta: composer install"
          else
            echo "‚úÖ composer.lock existe"
          fi
          
          echo "‚úÖ Dependencias v√°lidas"
        continue-on-error: false

# ============================================================================
# RESUMEN DEL WORKFLOW
# ============================================================================
#
# Cada vez que:
# 1. Haces git push a feature/xyz ‚Üí Se ejecutan validaciones
# 2. Abres PR hacia release/development ‚Üí Se ejecutan validaciones
# 3. Abres PR hacia release/uat ‚Üí Se ejecutan validaciones
# 4. Abres PR hacia release/prod ‚Üí Se ejecutan validaciones
#
# Validaciones ejecutadas:
# ‚úÖ Sintaxis PHP correcta (sin errores)
# ‚úÖ Sin debug statements (die, var_dump, dd, exit)
# ‚úÖ Sin credenciales hardcodeadas
# ‚úÖ composer.json y composer.lock v√°lidos
#
# Si TODO pasa ‚úÖ:
# - Bitbucket muestra: "All checks passed ‚úÖ"
# - El PR se puede mergear
#
# Si ALGO falla ‚ùå:
# - Bitbucket muestra: "Checks failed ‚ùå"
# - Debes arreglarlo en tu feature branch
# - Haces push nuevamente
# - El workflow se ejecuta autom√°ticamente
#
# IMPORTANTE PARA TU EQUIPO:
# - NUNCA mergear un PR con checks fallidos
# - Siempre reviewear antes de mergear
# - Los checks no son "opcioniales", son obligatorios
